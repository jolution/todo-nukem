# TODO NUKEM - PR Ticket Link Action
# Automatically adds ticket links to PR descriptions based on branch names
# https://github.com/jolution/todo-nukem

name: "TODO NUKEM PR Ticket Link"
description: "Automatically adds ticket links to PR descriptions based on branch names"
author: "jolution"

branding:
  icon: "link"
  color: "blue"

inputs:
  github-token:
    description: "GitHub token for API access"
    required: true
    default: ${{ github.token }}

runs:
  using: "composite"
  steps:
    - name: Read ticketBaseUrl
      shell: bash
      run: |
        # Try .todonukem.json first (local override)
        if [ -f .todonukem.json ]; then
          TICKET_BASE_URL=$(jq -r '.ticketBaseUrl // empty' .todonukem.json)
          if [ -n "$TICKET_BASE_URL" ]; then
            echo "âœ… Using ticketBaseUrl from .todonukem.json"
            echo "TICKET_BASE_URL=$TICKET_BASE_URL" >> $GITHUB_ENV
            exit 0
          fi
        fi

        # Fallback to package.json
        if [ -f package.json ]; then
          TICKET_BASE_URL=$(jq -r '.todonukem.ticketBaseUrl // empty' package.json)
          if [ -n "$TICKET_BASE_URL" ]; then
            echo "âœ… Using ticketBaseUrl from package.json"
            echo "TICKET_BASE_URL=$TICKET_BASE_URL" >> $GITHUB_ENV
            exit 0
          fi
        fi

        echo "âŒ Error: ticketBaseUrl not found in .todonukem.json or package.json"
        exit 1

    - name: Extract ticket number from branch
      shell: bash
      run: |
        BRANCH_NAME=${GITHUB_HEAD_REF}
        TICKET_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+')
        if [ -z "$TICKET_NUMBER" ]; then
          echo "âŒ No ticket number found in branch name"
          exit 1
        fi
        echo "ðŸŽ« Found ticket number: $TICKET_NUMBER"
        echo "TICKET_NUMBER=$TICKET_NUMBER" >> $GITHUB_ENV

    - name: Update PR body
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const pr_number = context.payload.pull_request.number;

          // Get current PR
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr_number
          });

          const current_body = pr.body || '';
          
          const ticket_link = `[ ðŸŽ« [${process.env.TICKET_NUMBER}](${process.env.TICKET_BASE_URL}${process.env.TICKET_NUMBER}) ]

          *via [TODO NUKEM](https://github.com/jolution/todo-nukem)*`;

          // Append ticket link to existing description
          const new_body = current_body 
            ? `${current_body}\n\n---\n${ticket_link}`
            : ticket_link;

          await github.rest.pulls.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr_number,
            body: new_body
          });
          console.log('âœ¨ Ticket link appended to PR description');
